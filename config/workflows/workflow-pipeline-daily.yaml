# Pipeline Daily Workflow
# Uses the mlb-etl pipeline command for simplified orchestration
# This replaces the multi-step ingest+transform workflows
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: pipeline-daily
  namespace: mlb-data-platform
  labels:
    app: mlb-data-platform
    component: pipeline
    schedule: daily
spec:
  entrypoint: pipeline-daily

  # Workflow-level parameters
  arguments:
    parameters:
      - name: date
        value: ""  # Empty = today
      - name: sport-id
        value: "1"  # MLB
      - name: enrich
        value: "true"  # Fetch player/team enrichment
      - name: dry-run
        value: "false"

  # Service account for accessing secrets
  serviceAccountName: mlb-data-platform-sa

  # Parallelism limits
  parallelism: 5

  templates:
    # Main pipeline using new CLI command
    - name: pipeline-daily
      dag:
        tasks:
          # Run the pipeline daily command
          - name: run-daily-pipeline
            template: run-pipeline
            arguments:
              parameters:
                - name: action
                  value: "daily"
                - name: date
                  value: "{{workflow.parameters.date}}"

          # Generate summary report
          - name: generate-report
            template: pipeline-report
            dependencies: [run-daily-pipeline]

    # Template: Run pipeline command
    - name: run-pipeline
      inputs:
        parameters:
          - name: action
          - name: date
      container:
        image: mlb-data-platform/ingestion:latest
        command: [uv, run, mlb-etl, pipeline]
        args:
          - "{{inputs.parameters.action}}"
          - --save
          - --db-host
          - $(POSTGRES_HOST)
          - --db-port
          - "5432"
          - --db-name
          - $(POSTGRES_DB)
          - --db-user
          - $(POSTGRES_USER)
          - --db-password
          - $(POSTGRES_PASSWORD)
          - --sport-id
          - "{{workflow.parameters.sport-id}}"
          # Conditionally add date if provided
        env:
          - name: POSTGRES_HOST
            valueFrom:
              secretKeyRef:
                name: postgres-credentials
                key: host
          - name: POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: postgres-credentials
                key: username
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: postgres-credentials
                key: password
          - name: POSTGRES_DB
            value: mlb_games
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"

    # Template: Pipeline summary report
    - name: pipeline-report
      script:
        image: postgres:15-alpine
        command: [sh]
        source: |
          #!/bin/sh
          set -e

          echo "=== MLB Pipeline Daily Report ==="
          echo "Date: $(date +%Y-%m-%d)"
          echo ""

          echo "Recent Ingestion (last 24 hours):"
          PGPASSWORD=$POSTGRES_PASSWORD psql \
            -h $POSTGRES_HOST \
            -U $POSTGRES_USER \
            -d $POSTGRES_DB \
            -c "SELECT
                  'season.seasons' as table_name, COUNT(*) as rows
                FROM season.seasons
                WHERE captured_at >= NOW() - INTERVAL '24 hours'
                UNION ALL
                SELECT
                  'schedule.schedule', COUNT(*)
                FROM schedule.schedule
                WHERE captured_at >= NOW() - INTERVAL '24 hours'
                UNION ALL
                SELECT
                  'game.live_game_v1', COUNT(*)
                FROM game.live_game_v1
                WHERE captured_at >= NOW() - INTERVAL '24 hours';"

          echo ""
          echo "Pipeline complete!"
        env:
          - name: POSTGRES_HOST
            valueFrom:
              secretKeyRef:
                name: postgres-credentials
                key: host
          - name: POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: postgres-credentials
                key: username
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: postgres-credentials
                key: password
          - name: POSTGRES_DB
            value: mlb_games

  # Retry strategy
  retryStrategy:
    limit: 2
    retryPolicy: "OnFailure"
    backoff:
      duration: "30s"
      factor: 2
      maxDuration: "5m"

  # TTL after completion
  ttlStrategy:
    secondsAfterCompletion: 86400
    secondsAfterSuccess: 86400
    secondsAfterFailure: 172800
